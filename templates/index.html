<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Apache Tika Upload Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex">
    <!-- Responsive layout: 1 column on small screens, 3 columns on md+ with left=1/3 and right=2/3 -->
    <div class="grid grid-cols-1 md:grid-cols-3 w-full gap-6">
        <!-- Left side: form -->
        <div class="bg-white shadow-lg p-6 md:col-span-1 max-w-full">
            <h1 class="text-2xl font-bold text-blue-600 mb-4">Apache Tika — Upload Demo</h1>
            <p class="text-gray-600 mb-6 text-sm">
                Upload a file and send it to your running <code>tika-server</code>
                (default <span class="font-mono">http://localhost:9998</span>).
                Choose an endpoint to extract text, metadata, or both.
            </p>

            <form id="uploadForm" class="space-y-4">
                <!-- Loại bỏ lựa chọn endpoint: luôn dùng /rmeta -->

                <div>
                    <label class="block text-gray-700 font-medium mb-1">File</label>
                    <input type="file" name="file" required class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4
                   file:rounded-lg file:border-0 file:text-sm file:font-semibold
                   file:bg-blue-50 file:text-blue-600 hover:file:bg-blue-100" />
                </div>

                <div class="flex space-x-3">
                    <button type="submit" id="submitBtn"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg">
                        Upload & Get Result
                    </button>
                    <button type="button" id="clear"
                        class="bg-gray-400 hover:bg-gray-500 text-white font-semibold px-4 py-2 rounded-lg">
                        Clear
                    </button>
                </div>

                <div id="loading" class="hidden mt-4 text-blue-600 flex items-center space-x-2">
                    <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                    </svg>
                    <span>Analyzing file...</span>
                </div>
            </form>
        </div>

    <!-- Right side: result (span 2 cols on md screens) -->
    <div class="bg-gray-50 p-8 border-l border-gray-200 md:col-span-2">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Result</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <h3 class="text-sm font-medium text-gray-600 mb-2">Content</h3>
                    <pre id="contentResult" class="bg-gray-900 text-green-200 p-4 rounded-lg overflow-auto max-h-[600px] whitespace-pre-wrap break-words">No request yet. Upload a file to see content.</pre>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-600 mb-2">Metadata</h3>
                    <pre id="metaResult" class="bg-gray-800 text-yellow-200 p-4 rounded-lg overflow-auto max-h-[600px] whitespace-pre-wrap break-words">No request yet. Upload a file to see metadata.</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById("uploadForm");
    const contentResult = document.getElementById("contentResult");
    const metaResult = document.getElementById("metaResult");
        const clearBtn = document.getElementById("clear");
        const submitBtn = document.getElementById("submitBtn");
        const loading = document.getElementById("loading");

        clearBtn.addEventListener("click", () => {
            contentResult.textContent = 'No request yet. Upload a file to see content.';
            metaResult.textContent = 'No request yet. Upload a file to see metadata.';
        });

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(form);

            // Disable button + show loading
            submitBtn.disabled = true;
            submitBtn.classList.add("opacity-50", "cursor-not-allowed");
            loading.classList.remove("hidden");

            try {
                const resp = await fetch("/upload", { method: "POST", body: formData });
                const contentType = resp.headers.get("Content-Type") || "";
                const text = await resp.text();

                // Mong đợi /rmeta trả về JSON: mảng các object (rmeta format) hoặc object
                if (contentType.includes("application/json")) {
                    try {
                        const obj = JSON.parse(text);

                        // Tika /rmeta thường trả mảng rmeta, mỗi phần tử là object metadata kèm content
                        // Tìm content (text) và metadata (tất cả keys khác)
                        let content = '';
                        let metadata = {};

                        if (Array.isArray(obj) && obj.length > 0) {
                            // Nhiều phần tử: hợp nhất metadata từ phần tử đầu tiên và tìm nội dung
                            const first = obj[0];
                            metadata = {...first};
                            // Tika có thể để nội dung raw trong key 'X-TIKA:content' hoặc 'content'
                            if (first['X-TIKA:content']) {
                                content = first['X-TIKA:content'];
                                delete metadata['X-TIKA:content'];
                            } else if (first['content']) {
                                content = first['content'];
                                delete metadata['content'];
                            } else {
                                // Không tìm thấy content, cố thử ghép tất cả giá trị string
                                content = '';
                            }
                        } else if (typeof obj === 'object' && obj !== null) {
                            metadata = {...obj};
                            if (obj['X-TIKA:content']) {
                                content = obj['X-TIKA:content'];
                                delete metadata['X-TIKA:content'];
                            } else if (obj['content']) {
                                content = obj['content'];
                                delete metadata['content'];
                            }
                        } else {
                            // Nếu không phải JSON object/array, hiển thị nguyên text ở content
                            content = text;
                            metadata = {};
                        }

                        // Hiển thị
                        contentResult.textContent = content || '(no extracted content)';
                        metaResult.textContent = JSON.stringify(metadata, null, 2) || '(no metadata)';

                    } catch (err) {
                        // Nếu JSON lỗi, hiển thị thô vào content
                        contentResult.textContent = text;
                        metaResult.textContent = '(could not parse metadata)';
                    }
                } else {
                    // Nếu không phải JSON, đặt nội dung nguyên thô
                    contentResult.textContent = text;
                    metaResult.textContent = '(no metadata)';
                }

            } catch (err) {
                result.textContent = "Error: " + err.message;
            } finally {
                // Enable button + hide loading
                submitBtn.disabled = false;
                submitBtn.classList.remove("opacity-50", "cursor-not-allowed");
                loading.classList.add("hidden");
            }
        });
    </script>
</body>

</html>