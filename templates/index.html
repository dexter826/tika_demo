<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Apache Tika Upload Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Prism.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markup.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex">
    <!-- Responsive layout: 1 column on small screens, 3 columns on md+ with left=1/3 and right=2/3 -->
    <div class="grid grid-cols-1 md:grid-cols-3 w-full gap-6">
        <!-- Left side: form -->
        <div class="bg-white shadow-lg p-6 md:col-span-1 max-w-full">
            <h1 class="text-2xl font-bold text-blue-600 mb-4">Apache Tika — Upload Demo</h1>
            <p class="text-gray-600 mb-6 text-sm">
                Upload a file and send it to your running <code>tika-server</code>
                (default <span class="font-mono">http://localhost:9998</span>).
                Choose an endpoint to extract text, metadata, or both.
            </p>

            <form id="uploadForm" class="space-y-4">
                <!-- Loại bỏ lựa chọn endpoint: luôn dùng /rmeta -->

                <div>
                    <label class="block text-gray-700 font-medium mb-1">File</label>
                    <input type="file" name="file" required class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4
                   file:rounded-lg file:border-0 file:text-sm file:font-semibold
                   file:bg-blue-50 file:text-blue-600 hover:file:bg-blue-100" />
                </div>

                <div class="flex space-x-3">
                    <button type="submit" id="submitBtn"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg">
                        Upload & Get Result
                    </button>
                    <button type="button" id="clear"
                        class="bg-gray-400 hover:bg-gray-500 text-white font-semibold px-4 py-2 rounded-lg">
                        Clear
                    </button>
                </div>

                <div id="loading" class="hidden mt-4 text-blue-600 flex items-center space-x-2">
                    <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                    </svg>
                    <span>Analyzing file...</span>
                </div>
            </form>
        </div>

    <!-- Right side: result (span 2 cols on md screens) -->
    <div class="bg-gray-50 p-8 border-l border-gray-200 md:col-span-2">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Result</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <h3 class="text-sm font-medium text-gray-600 mb-2">Content</h3>
                    <div class="mb-2 flex space-x-2" id="contentTabs">
                        <button type="button" class="tab-btn bg-blue-100 text-blue-700 px-2 py-1 rounded" data-mode="raw">Raw</button>
                        <button type="button" class="tab-btn bg-gray-100 text-gray-700 px-2 py-1 rounded" data-mode="text">Text</button>
                        <button type="button" class="tab-btn bg-gray-100 text-gray-700 px-2 py-1 rounded" data-mode="rendered">Rendered</button>
                    </div>
                    <div id="contentViews">
                        <pre id="contentRaw" class="bg-gray-900 text-green-200 p-4 rounded-lg overflow-auto max-h-[600px] whitespace-pre-wrap break-words"><code class="language-markup">No request yet. Upload a file to see content.</code></pre>
                        <pre id="contentText" class="bg-gray-900 text-green-200 p-4 rounded-lg overflow-auto max-h-[600px] whitespace-pre-wrap break-words hidden"><code class="language-none"></code></pre>
                        <div id="contentRendered" class="rounded-lg overflow-auto max-h-[600px] border border-gray-300 hidden">
                            <iframe id="contentIframe" sandbox="allow-same-origin" class="w-full h-[400px] bg-white"></iframe>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-600 mb-2">Metadata</h3>
                    <div id="metaContainer" class="bg-gray-800 text-yellow-200 p-4 rounded-lg overflow-auto max-h-[600px]">
                        <table id="metaTable" class="w-full text-left text-xs">
                            <thead>
                                <tr>
                                    <th class="border-b border-gray-700 pb-1 pr-2">Key</th>
                                    <th class="border-b border-gray-700 pb-1">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="2" class="py-2">No request yet. Upload a file to see metadata.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById("uploadForm");
    const contentRaw = document.getElementById("contentRaw");
    const contentText = document.getElementById("contentText");
    const contentRendered = document.getElementById("contentRendered");
    const contentIframe = document.getElementById("contentIframe");
    const contentTabs = document.getElementById("contentTabs");
    const metaTable = document.getElementById("metaTable");
        const clearBtn = document.getElementById("clear");
        const submitBtn = document.getElementById("submitBtn");
        const loading = document.getElementById("loading");

        clearBtn.addEventListener("click", () => {
            contentRaw.innerHTML = `<code class="language-markup">No request yet. Upload a file to see content.</code>`;
            contentText.innerHTML = `<code class="language-none"></code>`;
            contentRendered.classList.add('hidden');
            contentRaw.classList.remove('hidden');
            contentText.classList.add('hidden');
            metaTable.innerHTML = `<thead>
                <tr>
                    <th class='border-b border-gray-700 pb-1 pr-2'>Key</th>
                    <th class='border-b border-gray-700 pb-1'>Value</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan='2' class='py-2'>No request yet. Upload a file to see metadata.</td></tr>
            </tbody>`;
        });

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(form);

            // Disable button + show loading
            submitBtn.disabled = true;
            submitBtn.classList.add("opacity-50", "cursor-not-allowed");
            loading.classList.remove("hidden");

            try {
                const resp = await fetch("/upload", { method: "POST", body: formData });
                const contentType = resp.headers.get("Content-Type") || "";
                const text = await resp.text();

                // Mong đợi /rmeta trả về JSON: mảng các object (rmeta format) hoặc object
                if (contentType.includes("application/json")) {
                    try {
                        const obj = JSON.parse(text);

                        // Tika /rmeta thường trả mảng rmeta, mỗi phần tử là object metadata kèm content
                        // Tìm content (text) và metadata (tất cả keys khác)
                        let content = '';
                        let metadata = {};
                        let isHtmlContent = false;
                        let rawContent = '';
                        let textContent = '';

                        if (Array.isArray(obj) && obj.length > 0) {
                            const first = obj[0];
                            metadata = {...first};
                            if (first['X-TIKA:content']) {
                                content = first['X-TIKA:content'];
                                delete metadata['X-TIKA:content'];
                            } else if (first['content']) {
                                content = first['content'];
                                delete metadata['content'];
                            } else {
                                content = '';
                            }
                        } else if (typeof obj === 'object' && obj !== null) {
                            metadata = {...obj};
                            if (obj['X-TIKA:content']) {
                                content = obj['X-TIKA:content'];
                                delete metadata['X-TIKA:content'];
                            } else if (obj['content']) {
                                content = obj['content'];
                                delete metadata['content'];
                            }
                        } else {
                            content = text;
                            metadata = {};
                        }

                        // Kiểm tra nếu content là HTML (bắt đầu bằng <html hoặc <!DOCTYPE)
                        if (typeof content === 'string' && content.trim().match(/^<(html|!DOCTYPE)/i)) {
                            isHtmlContent = true;
                        }
                        rawContent = content || '(no extracted content)';
                        // Lấy text từ HTML nếu là HTML
                        if (isHtmlContent) {
                            // Tạo element tạm để lấy text
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = content;
                            textContent = tempDiv.innerText.trim() || '(no extracted text)';
                        } else {
                            textContent = content || '(no extracted content)';
                        }

                        // Hiển thị content ở các chế độ
                        contentRaw.innerHTML = isHtmlContent
                            ? `<code class="language-markup">${Prism.highlight(rawContent, Prism.languages.markup, 'markup')}</code>`
                            : `<code class="language-none">${Prism.util.encode(rawContent)}</code>`;
                        contentText.innerHTML = `<code class="language-none">${Prism.util.encode(textContent)}</code>`;
                        if (isHtmlContent) {
                            contentIframe.srcdoc = rawContent;
                        } else {
                            contentIframe.srcdoc = `<pre>${Prism.util.encode(rawContent)}</pre>`;
                        }
                        // Mặc định hiển thị Raw
                        contentRaw.classList.remove('hidden');
                        contentText.classList.add('hidden');
                        contentRendered.classList.add('hidden');
                        // Hiển thị tab Rendered nếu là HTML, ẩn nếu không
                        contentTabs.querySelector('[data-mode="rendered"]').style.display = isHtmlContent ? '' : 'none';

                        // Hiển thị metadata dưới dạng bảng, highlight giá trị nếu là JSON
                        let rows = '';
                        const keys = Object.keys(metadata);
                        if (keys.length === 0) {
                            rows = `<tr><td colspan='2' class='py-2'>(no metadata)</td></tr>`;
                        } else {
                            for (const key of keys) {
                                let value = metadata[key];
                                let valueHtml = '';
                                if (typeof value === 'object' && value !== null) {
                                    valueHtml = `<code class='language-json'>${Prism.highlight(JSON.stringify(value, null, 2), Prism.languages.json, 'json')}</code>`;
                                } else if (typeof value === 'string' && value.trim().startsWith('{')) {
                                    // Nếu là chuỗi JSON
                                    try {
                                        valueHtml = `<code class='language-json'>${Prism.highlight(value, Prism.languages.json, 'json')}</code>`;
                                    } catch {
                                        valueHtml = Prism.util.encode(value);
                                    }
                                } else {
                                    valueHtml = Prism.util.encode(value);
                                }
                                rows += `<tr><td class='pr-2 align-top font-mono break-words'>${Prism.util.encode(key)}</td><td class='align-top break-words'>${valueHtml}</td></tr>`;
                            }
                        }
                        metaTable.innerHTML = `<thead>
                            <tr>
                                <th class='border-b border-gray-700 pb-1 pr-2'>Key</th>
                                <th class='border-b border-gray-700 pb-1'>Value</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>`;

                    } catch (err) {
                        // Nếu JSON lỗi, hiển thị thô vào content
                        contentResult.textContent = text;
                        metaTable.innerHTML = `<thead>
                            <tr>
                                <th class='border-b border-gray-700 pb-1 pr-2'>Key</th>
                                <th class='border-b border-gray-700 pb-1'>Value</th>
                            </tr>
                        </thead>
                        <tbody><tr><td colspan='2' class='py-2'>(could not parse metadata)</td></tr></tbody>`;
                    }
                } else {
                    // Nếu không phải JSON, đặt nội dung nguyên thô
                    contentRaw.innerHTML = `<code class="language-none">${Prism.util.encode(text)}</code>`;
                    contentText.innerHTML = `<code class="language-none">${Prism.util.encode(text)}</code>`;
                    contentRendered.classList.add('hidden');
                    contentRaw.classList.remove('hidden');
                    contentText.classList.add('hidden');
                    contentTabs.querySelector('[data-mode="rendered"]').style.display = 'none';
                    metaTable.innerHTML = `<thead>
                        <tr>
                            <th class='border-b border-gray-700 pb-1 pr-2'>Key</th>
                            <th class='border-b border-gray-700 pb-1'>Value</th>
                        </tr>
                    </thead>
                    <tbody><tr><td colspan='2' class='py-2'>(no metadata)</td></tr></tbody>`;
                }

            } catch (err) {
                result.textContent = "Error: " + err.message;
            } finally {
                // Enable button + hide loading
                submitBtn.disabled = false;
                submitBtn.classList.remove("opacity-50", "cursor-not-allowed");
                loading.classList.add("hidden");
            }
        });

        // Xử lý chuyển tab content
        contentTabs.addEventListener('click', (e) => {
            if (!e.target.classList.contains('tab-btn')) return;
            const mode = e.target.getAttribute('data-mode');
            // Đổi style cho tab
            contentTabs.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'text-blue-700');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            e.target.classList.add('bg-blue-100', 'text-blue-700');
            e.target.classList.remove('bg-gray-100', 'text-gray-700');
            // Hiển thị đúng view
            if (mode === 'raw') {
                contentRaw.classList.remove('hidden');
                contentText.classList.add('hidden');
                contentRendered.classList.add('hidden');
            } else if (mode === 'text') {
                contentRaw.classList.add('hidden');
                contentText.classList.remove('hidden');
                contentRendered.classList.add('hidden');
            } else if (mode === 'rendered') {
                contentRaw.classList.add('hidden');
                contentText.classList.add('hidden');
                contentRendered.classList.remove('hidden');
            }
        });
    </script>
</body>

</html>